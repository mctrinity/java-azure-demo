name: Deploy Java App to Azure with Terraform

on:
  push:
    branches: ['main']

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      ARM_ACCESS_KEY: ${{ secrets.ARM_ACCESS_KEY }}
      AZURE_CREDENTIALS: ${{ secrets.AZURE_CREDENTIALS }}
      JAVA_VERSION: '17'
      RESOURCE_GROUP: 'java-azure-demo-rg'
      TF_DIR: 'infra'

    steps:
      # -----------------------------------------------
      # Step 1: Checkout code
      # -----------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -----------------------------------------------
      # Step 2: Mask Secrets
      # -----------------------------------------------
      - name: Mask all sensitive data
        run: |
          echo "::add-mask::${{ secrets.AZURE_CREDENTIALS }}"
          echo "::add-mask::${{ secrets.ARM_ACCESS_KEY }}"
          echo "‚úÖ Masking applied for Azure credentials and Terraform backend key."

      # -----------------------------------------------
      # Step 3: Set up Terraform
      # -----------------------------------------------
      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.8

      # -----------------------------------------------
      # Step 4: Terraform Init
      # -----------------------------------------------
      - name: Terraform Init
        working-directory: ${{ env.TF_DIR }}
        run: terraform init -input=false -no-color

      # -----------------------------------------------
      # Step 5: Authenticate with Azure
      # -----------------------------------------------
      - name: Azure Login (Service Principal)
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # -----------------------------------------------
      # Step 5.5: Verify Required Providers (Non-blocking)
      # -----------------------------------------------
      - name: Verify Azure Providers
        continue-on-error: true
        run: |
          echo "ÔøΩ Checking required Azure providers..."
          az provider show --namespace Microsoft.App --query "registrationState" -o tsv || echo "Microsoft.App: Unknown"
          az provider show --namespace Microsoft.ContainerRegistry --query "registrationState" -o tsv || echo "Microsoft.ContainerRegistry: Unknown"
          az provider show --namespace Microsoft.OperationalInsights --query "registrationState" -o tsv || echo "Microsoft.OperationalInsights: Unknown"
          echo "‚ÑπÔ∏è If any providers show 'NotRegistered', they need to be registered by a subscription admin"

      # -----------------------------------------------
      # Step 6: Check and Import Resource Group if Needed
      # -----------------------------------------------
      - name: Check and Import Resource Group
        id: rg-import
        working-directory: ${{ env.TF_DIR }}
        env:
          AZURE_SUBSCRIPTION_ID: ${{ fromJson(secrets.AZURE_CREDENTIALS).subscriptionId }}
          RESOURCE_GROUP: ${{ env.RESOURCE_GROUP }}
        run: |
          set -e
          echo "üîç Checking if Resource Group exists..."
          if az group show --name "$RESOURCE_GROUP" --subscription "$AZURE_SUBSCRIPTION_ID" > /dev/null 2>&1; then
            echo "‚úÖ Resource Group $RESOURCE_GROUP exists."
            echo "Checking if it's tracked by Terraform..."
            terraform state list | grep "azurerm_resource_group.rg" > /dev/null 2>&1 || {
              echo "üì¶ Importing existing Resource Group into Terraform state..."
              terraform import -no-color \
                -var='azure_credentials=${{ secrets.AZURE_CREDENTIALS }}' \
                azurerm_resource_group.rg \
                /subscriptions/$AZURE_SUBSCRIPTION_ID/resourceGroups/$RESOURCE_GROUP \
                || echo "‚ÑπÔ∏è Import may already exist or failed gracefully. Continuing..."
            }
          else
            echo "üÜï Resource Group does not exist. Terraform will create it."
          fi

      # -----------------------------------------------
      # Step 7: Drift Detection
      # -----------------------------------------------
      - name: Check for Terraform Drift
        id: drift
        working-directory: ${{ env.TF_DIR }}
        continue-on-error: true
        run: |
          echo "üîé Running Terraform plan to detect drift..."
          terraform plan -no-color -var='azure_credentials=${{ secrets.AZURE_CREDENTIALS }}' -detailed-exitcode > plan_output.txt 2>&1 || true
          code=$?
          if [ "$code" -eq 2 ]; then
            echo "‚ö†Ô∏è Drift detected ‚Äî infrastructure changes found."
            echo "drift_detected=true" >> $GITHUB_ENV
          elif [ "$code" -eq 0 ]; then
            echo "‚úÖ No drift detected ‚Äî infrastructure matches Terraform state."
            echo "drift_detected=false" >> $GITHUB_ENV
          else
            echo "‚ùå Terraform plan failed ‚Äî check output below."
            cat plan_output.txt | sed -E 's/[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}/[REDACTED-GUID]/g'
            exit 1
          fi
          cat plan_output.txt | sed -E 's/[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}/[REDACTED-GUID]/g' | sed -E 's/\/subscriptions\/[0-9a-f-]+/[REDACTED-SUBSCRIPTION]/g'

      # -----------------------------------------------
      # Step 8: Terraform Apply (Sensitive-safe)
      # -----------------------------------------------
      - name: Terraform Apply (Sensitive-safe)
        id: terraform-apply
        if: env.drift_detected == 'true' || env.drift_detected == 'false'
        working-directory: ${{ env.TF_DIR }}
        run: |
          set -e
          echo "üöÄ Applying Terraform changes..."
          
          # Apply with detailed logging
          terraform apply -auto-approve -no-color -var='azure_credentials=${{ secrets.AZURE_CREDENTIALS }}' \
          | sed -E 's/[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}/[REDACTED-GUID]/g' \
          | sed -E 's/[A-Za-z0-9+\/=]{20,}/[REDACTED-SECRET]/g' \
          | sed -E 's/\/subscriptions\/[0-9a-f-]+/[REDACTED-SUBSCRIPTION]/g' \
          | tee terraform_apply.log
          
          # Check if apply was successful
          if [ ${PIPESTATUS[0]} -ne 0 ]; then
            echo "::error::Terraform apply failed! Check the logs above."
            echo "üìã Terraform apply log:"
            cat terraform_apply.log
            exit 1
          fi
          
          # Verify that key resources were created
          echo "üîç Verifying Terraform outputs..."
          terraform output container_app_name || echo "::warning::No container_app_name output found"
          terraform output container_app_url || echo "::warning::No container_app_url output found"

      # -----------------------------------------------
      # Step 9: Set up Java
      # -----------------------------------------------
      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      # -----------------------------------------------
      # Step 10: Build JAR with Maven
      # -----------------------------------------------
      - name: Build application
        if: env.drift_detected == 'false' || env.drift_detected == 'true'
        run: mvn clean package -DskipTests

      # -----------------------------------------------
      # Step 11: Verify Container App exists before deployment
      # -----------------------------------------------
      - name: Verify Container App exists
        id: verify-container-app
        run: |
          echo "üîç Checking if Container App exists..."
          if az containerapp show --name java-azure-demo-app --resource-group java-azure-demo-rg > /dev/null 2>&1; then
            echo "‚úÖ Container App java-azure-demo-app exists."
            echo "container_app_exists=true" >> $GITHUB_ENV
            # Get the container app's ingress URL
            CONTAINER_APP_URL=$(az containerapp show --name java-azure-demo-app --resource-group java-azure-demo-rg --query "properties.configuration.ingress.fqdn" -o tsv)
            echo "üåê Container App URL: https://$CONTAINER_APP_URL"
          else
            echo "‚ùå Container App java-azure-demo-app does not exist!"
            echo "container_app_exists=false" >> $GITHUB_ENV
            echo "::error::Container App java-azure-demo-app was not created by Terraform. Please check the Terraform apply step."
            exit 1
          fi

      # -----------------------------------------------
      # Step 12: Build and Deploy Container to Azure Container Apps
      # -----------------------------------------------
      - name: Build and Deploy to Azure Container Apps
        if: env.container_app_exists == 'true'
        run: |
          echo "üê≥ Building and deploying container to Azure Container Apps..."
          
          # Build the container image and deploy directly to Container Apps
          az containerapp up \
            --name java-azure-demo-app \
            --resource-group java-azure-demo-rg \
            --environment java-azure-demo-app-env \
            --image mcr.microsoft.com/openjdk/jdk:17-ubuntu \
            --target-port 8080 \
            --ingress external \
            --source . \
            --cpu 0.25 \
            --memory 0.5Gi \
            --min-replicas 1 \
            --max-replicas 3
