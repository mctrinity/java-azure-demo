name: Deploy Java App to Azure with Terraform

on:
  push:
    branches: ['main']

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      ARM_ACCESS_KEY: ${{ secrets.ARM_ACCESS_KEY }}
      AZURE_CREDENTIALS: ${{ secrets.AZURE_CREDENTIALS }}
      JAVA_VERSION: '17'
      RESOURCE_GROUP: 'java-azure-demo-rg'
      TF_DIR: 'infra'

    steps:
      # -----------------------------------------------
      # Step 1: Checkout code
      # -----------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -----------------------------------------------
      # Step 2: Mask Secrets
      # -----------------------------------------------
      - name: Mask all sensitive data
        run: |
          echo "::add-mask::${{ secrets.AZURE_CREDENTIALS }}"
          echo "::add-mask::${{ secrets.ARM_ACCESS_KEY }}"
          echo "âœ… Masking applied for Azure credentials and Terraform backend key."

      # -----------------------------------------------
      # Step 3: Set up Terraform
      # -----------------------------------------------
      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.8

      # -----------------------------------------------
      # Step 4: Terraform Init
      # -----------------------------------------------
      - name: Terraform Init
        working-directory: ${{ env.TF_DIR }}
        run: terraform init -input=false -no-color

      # -----------------------------------------------
      # Step 5: Authenticate with Azure
      # -----------------------------------------------
      - name: Azure Login (Service Principal)
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # -----------------------------------------------
      # Step 6: Check and Import Resource Group if Needed
      # -----------------------------------------------
      - name: Check and Import Resource Group
        id: rg-import
        working-directory: ${{ env.TF_DIR }}
        env:
          AZURE_SUBSCRIPTION_ID: ${{ fromJson(secrets.AZURE_CREDENTIALS).subscriptionId }}
          RESOURCE_GROUP: ${{ env.RESOURCE_GROUP }}
        run: |
          set -e
          echo "ðŸ” Checking if Resource Group exists..."
          if az group show --name "$RESOURCE_GROUP" --subscription "$AZURE_SUBSCRIPTION_ID" > /dev/null 2>&1; then
            echo "âœ… Resource Group $RESOURCE_GROUP exists."
            echo "Checking if it's tracked by Terraform..."
            terraform state list | grep "azurerm_resource_group.rg" > /dev/null 2>&1 || {
              echo "ðŸ“¦ Importing existing Resource Group into Terraform state..."
              terraform import -no-color \
                -var='azure_credentials=${{ secrets.AZURE_CREDENTIALS }}' \
                azurerm_resource_group.rg \
                /subscriptions/$AZURE_SUBSCRIPTION_ID/resourceGroups/$RESOURCE_GROUP \
                || echo "â„¹ï¸ Import may already exist or failed gracefully. Continuing..."
            }
          else
            echo "ðŸ†• Resource Group does not exist. Terraform will create it."
          fi

      # -----------------------------------------------
      # Step 7: Drift Detection
      # -----------------------------------------------
      - name: Check for Terraform Drift
        id: drift
        working-directory: ${{ env.TF_DIR }}
        continue-on-error: true
        run: |
          echo "ðŸ”Ž Running Terraform plan to detect drift..."
          terraform plan -no-color -var='azure_credentials=${{ secrets.AZURE_CREDENTIALS }}' -detailed-exitcode > plan_output.txt 2>&1 || true
          code=$?
          if [ "$code" -eq 2 ]; then
            echo "âš ï¸ Drift detected â€” infrastructure changes found."
            echo "drift_detected=true" >> $GITHUB_ENV
          elif [ "$code" -eq 0 ]; then
            echo "âœ… No drift detected â€” infrastructure matches Terraform state."
            echo "drift_detected=false" >> $GITHUB_ENV
          else
            echo "âŒ Terraform plan failed â€” check output below."
            cat plan_output.txt | sed -E 's/[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}/[REDACTED-GUID]/g'
            exit 1
          fi
          cat plan_output.txt | sed -E 's/[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}/[REDACTED-GUID]/g' | sed -E 's/\/subscriptions\/[0-9a-f-]+/[REDACTED-SUBSCRIPTION]/g'

      # -----------------------------------------------
      # Step 8: Terraform Apply (Sensitive-safe)
      # -----------------------------------------------
      - name: Terraform Apply (Sensitive-safe)
        id: terraform-apply
        if: env.drift_detected == 'true' || env.drift_detected == 'false'
        working-directory: ${{ env.TF_DIR }}
        run: |
          set -e
          echo "ðŸš€ Applying Terraform changes..."
          terraform apply -auto-approve -no-color -var='azure_credentials=${{ secrets.AZURE_CREDENTIALS }}' \
          | sed -E 's/[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}/[REDACTED-GUID]/g' \
          | sed -E 's/[A-Za-z0-9+\/=]{20,}/[REDACTED-SECRET]/g' \
          | sed -E 's/\/subscriptions\/[0-9a-f-]+/[REDACTED-SUBSCRIPTION]/g'
          
          # Verify that key resources were created
          echo "ðŸ” Verifying Terraform outputs..."
          terraform output webapp_name || echo "::warning::No webapp_name output found"
          terraform output webapp_url || echo "::warning::No webapp_url output found"

      # -----------------------------------------------
      # Step 9: Set up Java
      # -----------------------------------------------
      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      # -----------------------------------------------
      # Step 10: Build JAR with Maven
      # -----------------------------------------------
      - name: Build application
        if: env.drift_detected == 'false' || env.drift_detected == 'true'
        run: mvn clean package -DskipTests

      # -----------------------------------------------
      # Step 11: Verify Web App exists before deployment
      # -----------------------------------------------
      - name: Verify Web App exists
        id: verify-webapp
        run: |
          echo "ðŸ” Checking if Web App exists..."
          if az webapp show --name java-azure-demo-app --resource-group java-azure-demo-rg > /dev/null 2>&1; then
            echo "âœ… Web App java-azure-demo-app exists."
            echo "webapp_exists=true" >> $GITHUB_ENV
          else
            echo "âŒ Web App java-azure-demo-app does not exist!"
            echo "webapp_exists=false" >> $GITHUB_ENV
            echo "::error::Web App java-azure-demo-app was not created by Terraform. Please check the Terraform apply step."
            exit 1
          fi

      # -----------------------------------------------
      # Step 12: Deploy JAR to Azure Web App
      # -----------------------------------------------
      - name: Deploy to Azure Web App
        if: env.webapp_exists == 'true'
        uses: azure/webapps-deploy@v3
        with:
          app-name: 'java-azure-demo-app'
          package: 'target/*.jar'
          slot-name: production
